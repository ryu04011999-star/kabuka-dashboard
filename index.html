<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>投資ファンドダッシュボード</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    const { useState, useEffect, createElement: e } = React;

    const funds = [
      { name: 'オルカン', symbol: '253425', color: '#3b82f6' },
      { name: 'S&P500', symbol: '253266', color: '#10b981' },
      { name: '宇宙開発', symbol: '253299', color: '#8b5cf6' },
      { name: 'NASDAQ100', symbol: '254062', color: '#f59e0b' },
      { name: '純金ファンド', symbol: '251065', color: '#ef4444' }
    ];

    // 静的JSONファイル
    const DATA_URL = './data/fund_history.json';

    // 表示系ユーティリティ
    const formatYen = (v) => `${Math.round(v).toLocaleString("ja-JP")}円`;
    const toYm = (isoDate) => isoDate ? isoDate.slice(0, 7).replace('-', '/') : '';

    const RefreshIcon = () =>
      e('svg', { className: 'w-4 h-4 animate-spin', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
        e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15' })
      );

    const RefreshIconStatic = () =>
      e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
        e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15' })
      );

    const TrendingUpIcon = () =>
      e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
        e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M13 7h8m0 0v8m0-8l-8 8-4-4-6 6' })
      );

    const TrendingDownIcon = () =>
      e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
        e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M13 17h8m0 0V9m0 8l-8-8-4 4-6-6' })
      );

    const AlertIcon = () =>
      e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
        e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' })
      );

    const MiniSparkline = ({ data, color }) => {
      if (!data || data.length === 0) return null;

      const prices = data.map(d => d.price);
      const min = Math.min(...prices);
      const max = Math.max(...prices);
      const range = max - min;

      if (range === 0) return null;

      const points = prices.map((price, index) => {
        const x = (index / (prices.length - 1)) * 100;
        const y = 100 - ((price - min) / range) * 100;
        return `${x},${y}`;
      }).join(' ');

      return e('svg', { viewBox: '0 0 100 100', className: 'w-24 h-12', preserveAspectRatio: 'none' },
        e('polyline', {
          points,
          fill: 'none',
          stroke: color,
          strokeWidth: '2',
          vectorEffect: 'non-scaling-stroke'
        })
      );
    };

    const SimpleChart = ({ data, funds, selectedFunds }) => {
      if (!data || data.length === 0) {
        return e('div', { className: 'text-slate-400 text-center py-20' }, 'データがありません');
      }

      const allPrices = [];
      funds.forEach(fund => {
        if (selectedFunds.includes(fund.name)) {
          data.forEach(d => {
            if (d[fund.name]) allPrices.push(d[fund.name]);
          });
        }
      });

      if (allPrices.length === 0) {
        return e('div', { className: 'text-slate-400 text-center py-20' }, 'データがありません');
      }

      const minPrice = Math.min(...allPrices);
      const maxPrice = Math.max(...allPrices);
      const priceRange = maxPrice - minPrice;

      if (priceRange === 0) {
        return e('div', { className: 'text-slate-400 text-center py-20' }, 'データの変動がありません');
      }

      const padding = 50;
      const width = 1000;
      const height = 520;
      const chartWidth = width - padding * 2;
      const chartHeight = height - padding * 2;

      const getX = (index) => padding + (index / (data.length - 1)) * chartWidth;
      const getY = (price) => padding + chartHeight - ((price - minPrice) / priceRange) * chartHeight;

      const xTicks = Array.from({ length: 6 }, (_, i) => {
        const idx = Math.round((data.length - 1) * (i / 5));
        const iso = data[idx]?.date;
        return { idx, label: toYm(iso) };
      });

      return e('svg', { width: '100%', height: height, viewBox: `0 0 ${width} ${height}`, className: 'bg-slate-900/50 rounded' },

        ...Array.from({ length: 6 }, (_, i) => {
          const y = padding + (i * chartHeight / 5);
          return e('line', {
            key: `grid-y-${i}`,
            x1: padding,
            y1: y,
            x2: width - padding,
            y2: y,
            stroke: '#334155',
            strokeDasharray: '3 3'
          });
        }),

        e('line', {
          x1: padding,
          y1: padding + chartHeight,
          x2: width - padding,
          y2: padding + chartHeight,
          stroke: '#475569'
        }),

        ...funds.map(fund => {
          if (!selectedFunds.includes(fund.name)) return null;

          const points = data
            .map((d, i) => d[fund.name] ? `${getX(i)},${getY(d[fund.name])}` : null)
            .filter(p => p)
            .join(' ');

          if (!points) return null;

          return e('polyline', {
            key: `line-${fund.name}`,
            points,
            fill: 'none',
            stroke: fund.color,
            strokeWidth: 2
          });
        }).filter(Boolean),

        ...Array.from({ length: 6 }, (_, i) => {
          const price = minPrice + (priceRange * i / 5);
          const y = padding + chartHeight - (i * chartHeight / 5);
          return e('text', {
            key: `y-label-${i}`,
            x: padding - 12,
            y: y + 5,
            fill: '#94a3b8',
            fontSize: 12,
            textAnchor: 'end'
          }, formatYen(price));
        }),

        ...xTicks.map((t, i) => {
          const x = getX(t.idx);
          const y = padding + chartHeight + 22;
          return e('text', {
            key: `x-label-${i}`,
            x,
            y,
            fill: '#94a3b8',
            fontSize: 12,
            textAnchor: 'middle'
          }, t.label);
        }),

        e('g', { transform: `translate(${padding}, ${height - 12})` },
          ...funds.map((fund, i) => {
            if (!selectedFunds.includes(fund.name)) return null;
            const x = i * 120;
            return e('g', { key: `legend-${fund.name}` },
              e('rect', { x, y: 0, width: 15, height: 3, fill: fund.color }),
              e('text', { x: x + 20, y: 5, fill: '#cbd5e1', fontSize: 12 }, fund.name)
            );
          }).filter(Boolean)
        )
      );
    };

    const FundDashboard = () => {
      const [fundData, setFundData] = useState({});
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [selectedFunds, setSelectedFunds] = useState(funds.map(f => f.name));
      const [latestDate, setLatestDate] = useState(null);

      useEffect(() => {
        fetchRealData();
      }, []);

      const fetchRealData = async () => {
        setLoading(true);
        setError(null);

        try {
          // キャッシュ対策
          const url = `${DATA_URL}?t=${Date.now()}`;
          const response = await fetch(url);

          if (!response.ok) {
            throw new Error(`サーバーエラー: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();

          if (!data || Object.keys(data).length === 0) {
            throw new Error('データが空です');
          }

          setFundData(data);
          
          // 最新の日付を取得
          let latestDate = null;
          for (const fundName of Object.keys(data)) {
            const series = data[fundName];
            if (series && series.length > 0) {
              latestDate = series[series.length - 1].date;
              break;
            }
          }
          setLatestDate(latestDate);
          setError(null);
        } catch (err) {
          setError(`データ取得エラー: ${err.message}`);
        }

        setLoading(false);
      };

      const calculateStats = (data) => {
        if (!data || data.length === 0) return { current: 0, change: 0, changePercent: 0 };

        const current = data[data.length - 1].price;
        const previous = data[0].price;
        const change = current - previous;
        const changePercent = ((change / previous) * 100).toFixed(2);

        return { current, change, changePercent };
      };

      const toggleFund = (fundName) => {
        setSelectedFunds(prev =>
          prev.includes(fundName)
            ? prev.filter(f => f !== fundName)
            : [...prev, fundName]
        );
      };

      const mergeDataForChart = () => {
        if (Object.keys(fundData).length === 0) return [];

        const firstFund = funds.find(f => fundData[f.name] && fundData[f.name].length > 0);
        if (!firstFund) return [];

        const dates = fundData[firstFund.name]?.map(d => d.date) || [];

        return dates.map(date => {
          const dataPoint = { date };
          funds.forEach(fund => {
            const dayData = fundData[fund.name]?.find(d => d.date === date);
            if (dayData) dataPoint[fund.name] = dayData.price;
          });
          return dataPoint;
        });
      };

      const getRangeText = (chartData) => {
        if (!chartData || chartData.length === 0) return '';
        const start = toYm(chartData[0]?.date);
        const end = toYm(chartData[chartData.length - 1]?.date);
        if (!start || !end) return '';
        return `期間：${start} 〜 ${end}`;
      };

      if (loading) {
        return e('div', { className: 'min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center' },
          e('div', { className: 'text-center' },
            e('div', { className: 'w-12 h-12 text-blue-400 mx-auto mb-4' }, e(RefreshIcon)),
            e('p', { className: 'text-slate-300 text-lg mb-2' }, 'データを読み込み中...'),
            e('p', { className: 'text-slate-500 text-sm' }, 'データを取得しています')
          )
        );
      }

      if (error) {
        return e('div', { className: 'min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-6' },
          e('div', { className: 'max-w-2xl w-full' },
            e('div', { className: 'bg-red-900/30 border border-red-600 rounded-lg p-6' },
              e('div', { className: 'flex items-start gap-3 mb-4' },
                e('div', { className: 'text-red-400 flex-shrink-0' }, e(AlertIcon)),
                e('div', null,
                  e('h2', { className: 'text-red-200 font-semibold text-lg mb-2' }, 'データ取得エラー'),
                  e('p', { className: 'text-red-300 text-sm mb-4' }, error)
                )
              ),
              e('button', {
                onClick: fetchRealData,
                className: 'bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors inline-flex items-center gap-2'
              },
                e(RefreshIconStatic),
                '再試行'
              )
            )
          )
        );
      }

      const chartData = mergeDataForChart();
      const rangeText = getRangeText(chartData);

      return e('div', { className: 'min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-6' },
        e('div', { className: 'max-w-7xl mx-auto' },

          e('div', { className: 'mb-8 flex items-center justify-between' },
            e('div', null,
              e('h1', { className: 'text-4xl font-bold text-white mb-2' }, '投資ファンドダッシュボード'),
              e('p', { className: 'text-slate-400' }, '過去1年のパフォーマンス(実データ)')
            ),
            latestDate && e('div', { className: 'text-slate-300 text-xl' },
              `${latestDate.replace(/-/g, '/')} 時点での金額`
            )
          ),

          e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8' },
            ...funds.map(fund => {
              const stats = calculateStats(fundData[fund.name]);
              const isPositive = stats.changePercent >= 0;
              const isSelected = selectedFunds.includes(fund.name);

              return e('div', {
                key: fund.name,
                onClick: () => toggleFund(fund.name),
                className: `bg-slate-800/50 backdrop-blur-sm rounded-xl p-5 border-2 transition-all cursor-pointer ${
                  isSelected
                    ? 'border-blue-500 shadow-lg shadow-blue-500/20'
                    : 'border-slate-700 hover:border-slate-600'
                }`
              },
                e('div', { className: 'flex items-start justify-between mb-3' },
                  e('div', { className: 'flex-1' },
                    e('div', { className: 'flex items-center justify-between mb-1' },
                      e('h3', { className: 'text-slate-200 font-semibold text-sm' }, fund.name),
                      e('div', { className: 'w-3 h-3 rounded-full flex-shrink-0', style: { backgroundColor: fund.color } })
                    ),
                    e('p', { className: 'text-2xl font-bold text-white mb-2' },
                      stats.current > 0 ? `¥${stats.current.toLocaleString("ja-JP")}` : '---'
                    ),
                    e('div', { className: 'flex items-center gap-2' },
                      e('div', { className: isPositive ? 'text-green-400' : 'text-red-400' },
                        isPositive ? e(TrendingUpIcon) : e(TrendingDownIcon)
                      ),
                      e('span', { className: `text-sm font-semibold ${isPositive ? 'text-green-400' : 'text-red-400'}` },
                        stats.current > 0 ? `${isPositive ? '+' : ''}${stats.changePercent}%` : '---'
                      ),
                      e('span', { className: 'text-slate-500 text-xs' }, '1年')
                    )
                  )
                ),
                e('div', { className: 'mt-3 flex justify-end' },
                  e(MiniSparkline, { data: fundData[fund.name], color: fund.color })
                )
              );
            })
          ),

          e('div', { className: 'bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 border border-slate-700' },
            e('h2', { className: 'text-xl font-semibold text-white mb-6' }, '価格推移チャート'),
            e(SimpleChart, { data: chartData, funds, selectedFunds }),
            e('p', { className: 'text-slate-300 text-sm mt-4 text-center' }, rangeText || '期間：---'),
            e('p', { className: 'text-slate-500 text-sm mt-2 text-center' },
              '※ 三菱UFJアセットマネジメントの投信情報APIを参照しています'
            )
          )
        )
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(e(FundDashboard));
  </script>
</body>
</html>
